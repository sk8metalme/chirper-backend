package com.chirper.presentation.controller;

import com.chirper.application.usecase.GetTimelineUseCase;
import com.chirper.domain.entity.Tweet;
import com.chirper.domain.valueobject.TweetContent;
import com.chirper.domain.valueobject.TweetId;
import com.chirper.domain.valueobject.UserId;
import com.chirper.infrastructure.security.JwtUtil;
import com.chirper.presentation.exception.GlobalExceptionHandler;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.security.test.context.support.WithMockUser;
import org.springframework.test.web.servlet.MockMvc;

import java.time.Instant;
import java.util.List;
import java.util.UUID;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.*;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

/**
 * TimelineControllerTest
 * TimelineControllerのテストクラス（TDD RED Phase）
 *
 * テスト対象:
 * - GET /api/v1/timeline (タイムライン取得)
 */
@WebMvcTest(controllers = TimelineController.class)
@AutoConfigureMockMvc(addFilters = false)

class TimelineControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private GetTimelineUseCase getTimelineUseCase;

    @MockBean
    private com.chirper.infrastructure.security.JwtAuthenticationFilter jwtAuthenticationFilter;

    @MockBean
    private JwtUtil jwtUtil;

    private UserId testUserId;
    private UserId followedUserId;
    private Tweet testTweet1;
    private Tweet testTweet2;

    @BeforeEach
    void setUp() {
        testUserId = UserId.of(UUID.randomUUID().toString());
        followedUserId = UserId.of(UUID.randomUUID().toString());

        // テストツイート作成
        testTweet1 = Tweet.create(followedUserId, new TweetContent("フォローユーザーのツイート1"));
        testTweet2 = Tweet.create(followedUserId, new TweetContent("フォローユーザーのツイート2"));

        // リフレクションでIDとcreatedAtを設定
        try {
            var idField = Tweet.class.getDeclaredField("id");
            idField.setAccessible(true);
            idField.set(testTweet1, new TweetId(UUID.randomUUID()));
            idField.set(testTweet2, new TweetId(UUID.randomUUID()));

            var createdAtField = Tweet.class.getDeclaredField("createdAt");
            createdAtField.setAccessible(true);
            createdAtField.set(testTweet1, Instant.now().minusSeconds(3600));
            createdAtField.set(testTweet2, Instant.now().minusSeconds(1800));
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }

    @Test
    @DisplayName("GET /api/v1/timeline - タイムライン取得成功（200 OK）")
    @WithMockUser(username = "test-user-id")
    void getTimeline_success() throws Exception {
        // Arrange
        var tweetWithStatus1 = new GetTimelineUseCase.TweetWithStatus(testTweet1, false, false);
        var tweetWithStatus2 = new GetTimelineUseCase.TweetWithStatus(testTweet2, true, false);
        var timelineResult = new GetTimelineUseCase.TimelineResult(List.of(tweetWithStatus1, tweetWithStatus2));

        when(getTimelineUseCase.execute(any(UserId.class), eq(0), eq(20)))
            .thenReturn(timelineResult);

        // Act & Assert
        mockMvc.perform(get("/api/v1/timeline")
                .param("page", "0")
                .param("size", "20"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.tweets").isArray())
            .andExpect(jsonPath("$.tweets.length()").value(2))
            .andExpect(jsonPath("$.tweets[0].tweetId").value(testTweet1.getId().value().toString()))
            .andExpect(jsonPath("$.tweets[0].content").value("フォローユーザーのツイート1"))
            .andExpect(jsonPath("$.tweets[0].likedByCurrentUser").value(false))
            .andExpect(jsonPath("$.tweets[0].retweetedByCurrentUser").value(false))
            .andExpect(jsonPath("$.tweets[1].tweetId").value(testTweet2.getId().value().toString()))
            .andExpect(jsonPath("$.tweets[1].content").value("フォローユーザーのツイート2"))
            .andExpect(jsonPath("$.tweets[1].likedByCurrentUser").value(true))
            .andExpect(jsonPath("$.tweets[1].retweetedByCurrentUser").value(false))
            .andExpect(jsonPath("$.totalPages").value(1));

        verify(getTimelineUseCase, times(1)).execute(any(UserId.class), eq(0), eq(20));
    }

    @Test
    @DisplayName("GET /api/v1/timeline - デフォルトページネーション（page=0, size=20）")
    @WithMockUser(username = "test-user-id")
    void getTimeline_defaultPagination() throws Exception {
        // Arrange
        var timelineResult = new GetTimelineUseCase.TimelineResult(List.of());
        when(getTimelineUseCase.execute(any(UserId.class), eq(0), eq(20)))
            .thenReturn(timelineResult);

        // Act & Assert
        mockMvc.perform(get("/api/v1/timeline"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.tweets").isArray())
            .andExpect(jsonPath("$.tweets.length()").value(0))
            .andExpect(jsonPath("$.totalPages").value(0));

        verify(getTimelineUseCase, times(1)).execute(any(UserId.class), eq(0), eq(20));
    }

    @Test
    @DisplayName("GET /api/v1/timeline - カスタムページネーション（page=1, size=10）")
    @WithMockUser(username = "test-user-id")
    void getTimeline_customPagination() throws Exception {
        // Arrange
        var tweetWithStatus = new GetTimelineUseCase.TweetWithStatus(testTweet1, false, false);
        var timelineResult = new GetTimelineUseCase.TimelineResult(List.of(tweetWithStatus));
        when(getTimelineUseCase.execute(any(UserId.class), eq(1), eq(10)))
            .thenReturn(timelineResult);

        // Act & Assert
        mockMvc.perform(get("/api/v1/timeline")
                .param("page", "1")
                .param("size", "10"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.tweets").isArray())
            .andExpect(jsonPath("$.tweets.length()").value(1));

        verify(getTimelineUseCase, times(1)).execute(any(UserId.class), eq(1), eq(10));
    }

    @Test
    @DisplayName("GET /api/v1/timeline - フォローユーザーが0件の場合（空のタイムライン）")
    @WithMockUser(username = "test-user-id")
    void getTimeline_noFollowedUsers() throws Exception {
        // Arrange
        var timelineResult = new GetTimelineUseCase.TimelineResult(List.of());
        when(getTimelineUseCase.execute(any(UserId.class), eq(0), eq(20)))
            .thenReturn(timelineResult);

        // Act & Assert
        mockMvc.perform(get("/api/v1/timeline"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.tweets").isArray())
            .andExpect(jsonPath("$.tweets.length()").value(0))
            .andExpect(jsonPath("$.totalPages").value(0));

        verify(getTimelineUseCase, times(1)).execute(any(UserId.class), eq(0), eq(20));
    }

    @Test
    @DisplayName("GET /api/v1/timeline - sizeが100を超える場合（バリデーションエラー）")
    @WithMockUser(username = "test-user-id")
    void getTimeline_sizeExceedsMax() throws Exception {
        // Act & Assert
        mockMvc.perform(get("/api/v1/timeline")
                .param("page", "0")
                .param("size", "101"))
            .andExpect(status().isBadRequest());

        verify(getTimelineUseCase, never()).execute(any(), anyInt(), anyInt());
    }

    @Test
    @DisplayName("GET /api/v1/timeline - 認証なしの場合（401 Unauthorized）")
    void getTimeline_unauthorized() throws Exception {
        // Act & Assert
        mockMvc.perform(get("/api/v1/timeline"))
            .andExpect(status().isUnauthorized());

        verify(getTimelineUseCase, never()).execute(any(), anyInt(), anyInt());
    }
}
